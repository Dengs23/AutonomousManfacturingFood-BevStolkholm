<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè≠ Swedish Manufacturing Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .dashboard-header {
            background: linear-gradient(135deg, #005293 0%, #003366 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
        }
        .sensor-value {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .realtime-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-3">
        <header class="dashboard-header">
            <h1><i class="fas fa-industry"></i> Swedish Manufacturing Dashboard</h1>
            <p class="mb-0">Stockholm Region | Real-time Kafka Monitoring</p>
            <div class="mt-2">
                <span id="connection-status" class="badge bg-success">Connected</span>
                <span id="update-time" class="text-light ms-2">Last update: --:--:--</span>
            </div>
        </header>

        <div class="row">
            <div class="col-md-4">
                <div class="card mb-3">
                    <div class="card-header">
                        <h5><i class="fas fa-cogs"></i> System Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <div class="text-center p-2 bg-light rounded">
                                    <h6>Production Cycles</h6>
                                    <h3 id="cycle-count" class="text-primary">0</h3>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center p-2 bg-light rounded">
                                    <h6>Active Alerts</h6>
                                    <h3 id="alert-count" class="text-success">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <h6>Current Factory</h6>
                            <h4 id="current-factory" class="text-info">--</h4>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-exclamation-triangle"></i> Alerts</h5>
                    </div>
                    <div class="card-body">
                        <div id="alerts-container">
                            <div class="alert alert-success" id="no-alerts">
                                <i class="fas fa-check-circle"></i> All systems normal
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card mb-3">
                    <div class="card-header">
                        <h5><i class="fas fa-microchip"></i> Live Sensor Data</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Sensor</th>
                                        <th>Value</th>
                                        <th>Unit</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="sensor-table">
                                    <!-- Sensor data will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6>System Uptime</h6>
                                <h2 id="uptime">99.7%</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6>Production Efficiency</h6>
                                <h2 id="efficiency">96.2%</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6>Quality Score</h6>
                                <h2 id="quality">98.1%</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="mt-4 text-center text-muted">
            <p>Swedish Autonomous Manufacturing System | Kafka Real-time Streaming | Stockholm Food & Beverage</p>
        </footer>
    </div>

    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script>
        // Connect to WebSocket server
        const socket = io();
        
        // Connection status
        socket.on('connect', () => {
            console.log('‚úÖ Connected to dashboard server');
            document.getElementById('connection-status').className = 'badge bg-success';
            document.getElementById('connection-status').textContent = 'Connected';
        });
        
        socket.on('disconnect', () => {
            document.getElementById('connection-status').className = 'badge bg-danger';
            document.getElementById('connection-status').textContent = 'Disconnected';
        });
        
        // Handle real-time data updates
        socket.on('data_update', (data) => {
            console.log('üìä Received data update:', data);
            updateDashboard(data);
            updateTime();
        });
        
        // Handle errors
        socket.on('error', (error) => {
            console.error('WebSocket error:', error);
            document.getElementById('connection-status').className = 'badge bg-warning';
            document.getElementById('connection-status').textContent = 'Error';
        });
        
        // Request initial data
        socket.emit('request_update');
        
        // Auto-refresh every 2 seconds
        setInterval(() => {
            socket.emit('request_update');
        }, 2000);
        
        function updateDashboard(data) {
            // Update cycle count
            if (data.system_status && data.system_status.cycle_id) {
                document.getElementById('cycle-count').textContent = data.system_status.cycle_id;
            }
            
            // Update alert count
            const alerts = data.alerts || [];
            document.getElementById('alert-count').textContent = alerts.length;
            
            // Update alerts display
            const alertsContainer = document.getElementById('alerts-container');
            const noAlerts = document.getElementById('no-alerts');
            
            if (alerts.length === 0) {
                noAlerts.style.display = 'block';
                alertsContainer.querySelectorAll('.alert-item').forEach(el => el.remove());
            } else {
                noAlerts.style.display = 'none';
                alertsContainer.querySelectorAll('.alert-item').forEach(el => el.remove());
                
                alerts.slice(0, 3).forEach(alert => {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert-item alert alert-warning mb-2';
                    alertDiv.innerHTML = `
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>${alert.message || 'Alert detected'}</strong>
                        <br>
                        <small class="text-muted">${alert.timestamp ? formatTime(alert.timestamp) : 'Just now'}</small>
                    `;
                    alertsContainer.appendChild(alertDiv);
                });
            }
            
            // Update sensor data
            const sensorData = data.sensor_data || {};
            const sensorTable = document.getElementById('sensor-table');
            sensorTable.innerHTML = '';
            
            // Define which sensors to display
            const displaySensors = [
                { key: 'temperature_c', name: 'Temperature', unit: '¬∞C' },
                { key: 'pressure_bar', name: 'Pressure', unit: 'bar' },
                { key: 'ph_level', name: 'pH Level', unit: 'pH' },
                { key: 'vibration_x', name: 'Vibration X', unit: 'g' },
                { key: 'flow_rate_lph', name: 'Flow Rate', unit: 'L/h' },
                { key: 'co2_ppm', name: 'CO‚ÇÇ', unit: 'ppm' },
                { key: 'brix_level', name: 'Brix Level', unit: '¬∞Bx' },
                { key: 'energy_kwh', name: 'Energy', unit: 'kWh' }
            ];
            
            displaySensors.forEach(sensor => {
                const value = sensorData[sensor.key];
                if (value !== undefined) {
                    const row = document.createElement('tr');
                    const status = getSensorStatus(sensor.key, value);
                    
                    row.innerHTML = `
                        <td>${sensor.name}</td>
                        <td class="sensor-value">${value}</td>
                        <td>${sensor.unit}</td>
                        <td>
                            <span class="badge bg-${status.color}">${status.text}</span>
                        </td>
                    `;
                    sensorTable.appendChild(row);
                }
            });
            
            // Update current factory
            if (sensorData.factory) {
                document.getElementById('current-factory').textContent = sensorData.factory;
            }
            
            // Update system metrics
            if (data.system_status && data.system_status.system_metrics) {
                const metrics = data.system_status.system_metrics;
                document.getElementById('uptime').textContent = `${metrics.uptime || '99.7'}%`;
                document.getElementById('efficiency').textContent = `${metrics.efficiency || '96.2'}%`;
                document.getElementById('quality').textContent = `${metrics.quality || '98.1'}%`;
            }
        }
        
        function getSensorStatus(sensor, value) {
            const thresholds = {
                'temperature_c': { min: 18, max: 28 },
                'pressure_bar': { min: 0.95, max: 1.05 },
                'vibration_x': { min: 0, max: 0.7 },
                'ph_level': { min: 6.0, max: 8.0 }
            };
            
            for (const [key, { min, max }] of Object.entries(thresholds)) {
                if (sensor.includes(key)) {
                    if (value < min || value > max) {
                        return { text: 'ALERT', color: 'danger' };
                    }
                }
            }
            return { text: 'OK', color: 'success' };
        }
        
        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            document.getElementById('update-time').textContent = `Last update: ${timeStr}`;
        }
        
        function formatTime(timestamp) {
            if (!timestamp) return 'N/A';
            try {
                const date = new Date(timestamp);
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } catch (e) {
                return timestamp;
            }
        }
        
        // Initial time display
        updateTime();
    </script>
</body>
</html>
